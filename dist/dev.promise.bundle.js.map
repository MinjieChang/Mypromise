{"version":3,"file":"dev.promise.bundle.js","sources":["../src/main.js"],"sourcesContent":["const stateMap = {\n  PENDING: 'PENDING',\n  FULFILED: 'FULFILED',\n  REJECT: 'REJECT',\n};\nclass Mypromise {\n  static allTwo(ps) {\n    // 这个all方法中可使用resolve回调的方式来做\n    const pCount = ps.length;\n    let count = 0;\n    const resultArr = new Array(pCount);\n    return new Mypromise((resolve, reject) => {\n      ps.forEach((p, idx) => {\n        p.resolveCallBack = (data) => {\n          count++;\n          resultArr[idx] = data;\n          if (count === pCount) {\n            resolve(resultArr);\n          }\n        };\n        p.rejectCallBack = (data) => {\n          reject(data);\n        };\n      });\n    });\n  }\n\n  static all(ps) {\n    const pCount = ps.length;\n    let count = 0;\n    const resultArr = new Array(pCount);\n    return new Mypromise((resolve, reject) => {\n      ps.forEach((p, idx) => {\n        p.then(data => {\n          count++\n          resultArr[idx] = data;\n          if(count === pCount){\n            resolve(resultArr)\n          }\n        }).catch(err => {\n          reject(err)\n        })\n      });\n    });\n  }\n\n  static race(ps) {\n    return new Mypromise((resolve, reject) => {\n      ps.forEach((p) => {\n        p.then(data => {\n          resolve(data);\n        }).catch(err => {\n          reject(err)\n        })\n      });\n    });\n  }\n\n  static resolve(value) {\n    return new Mypromise((resolve) => {\n      resolve(value);\n    });\n  }\n\n  static reject(value) {\n    return new Mypromise((resolve, reject) => {\n      reject(value);\n    });\n  }\n\n  constructor(executor) {\n    this.state = stateMap.PENDING;\n\n    this.resolveCallBacks = [];\n\n    this.rejectCallBacks = [];\n\n    const reject = (...args) => {\n      // 状态不为pengding，不执行\n      if (this.state !== stateMap.PENDING) {\n        return;\n      }\n      // 将状态置为 reject\n      this.state = stateMap.REJECT;\n      this.rejectCallBack && this.rejectCallBack(...args);\n      // 执行resoleve 回调\n      setTimeout(() => {\n        this.rejectCallBacks.forEach((cb) => {\n          if (typeof cb === 'function') {\n            cb(...args);\n          }\n        });\n      });\n    };\n\n    const resolve = (...args) => {\n      // 状态不为pengding，不执行, 状态不可逆 避免resolve被多次执行\n      if (this.state !== stateMap.PENDING) {\n        return;\n      }\n      // 将状态置为 fulfiled\n      this.state = stateMap.FULFILED;\n      // 状态改变后发布一个事件\n      this.resolveCallBack && this.resolveCallBack(...args);\n      // 执行resoleve 回调\n      // 由于then中的回调函数是在微任务中，所以此时使用setTimeout来模拟微任务\n      setTimeout(() => {\n        this.resolveCallBacks.forEach((cb) => {\n          if (typeof cb === 'function') {\n            cb(...args);\n          }\n        });\n      });\n    };\n\n    // 执行函数参数\n    try {\n      executor(resolve, reject);\n    } catch (error) {\n      reject(error);\n    }\n  }\n\n  then(resolveFn, rejectFn) {\n    resolveFn = resolveFn || ((data) => data);\n    rejectFn = rejectFn || ((data) => data);\n\n    // 每次执行会返回新的promise，\n    // 如果当前resolveFn 返回的是 非 MyPromise 实例，那么会将 resolveFn的结果 传给下个Mypromise的resolveFn\n    // 如果当前resolveFn 返回的是 MyPromise 实例, 那么此 MyPromise实例 将接管后面的then的回调，其实也就是接管当前实例\n\n    return new Mypromise((resolve, reject) => {\n      this.resolveCallBacks.push((...data) => {\n        try {\n          const result = resolveFn(...data);\n          // result instanceof Mypromise ? result.then(resolve, reject) : resolve()\n          if (result instanceof Mypromise) {\n            // 需要由result来接管后面的then回调\n            result.then(resolve, reject);\n          } else {\n            resolve(result);\n          }\n        } catch (error) {\n          reject(error);\n        }\n      });\n\n      this.rejectCallBacks.push((...data) => {\n        try {\n          const result = rejectFn(...data);\n          if (result instanceof Mypromise) {\n            // 需要由result来接管后面的then回调\n            result.then(resolve, reject);\n          } else {\n            reject(result)\n          }\n        } catch (error) {\n          reject(error);\n        }\n      });\n    });\n  }\n\n  catch (resolveFn, catchFn) {\n    catchFn = catchFn || resolveFn;\n    // return new Mypromise((resolve, reject) => {\n    //   // 此处resolve，让后面的finally回调执行\n    //   this.resolveCallBacks.push((...data) => {\n    //     resolve(...data)\n    //   });\n\n    //   this.rejectCallBacks.push((...data) => {\n    //     try {\n    //       const result = catchFn(...data);\n    //       if (result instanceof Mypromise) {\n    //         result.then(resolve, reject);\n    //       } else {\n    //         reject(result)\n    //       }\n    //     } catch (error) {\n    //       reject(error);\n    //     }\n    //     // result instanceof Mypromise ? result.then(resolve, reject) : reject(result);\n    //   });\n    // });\n\n    // 方式二\n    return this.then(\n      (data) => {\n        return Mypromise.resolve(data)\n      }, \n      (err) => {\n        try {\n          const result = catchFn(err)\n          return Mypromise.resolve(result)\n        } catch (error) {\n          return Mypromise.resolve(error)\n        }\n      }\n    )\n  }\n\n  finally(resolveFn, finallyFn) {\n    finallyFn = finallyFn || resolveFn;\n    // return new Mypromise((resolve, reject) => {\n    //   const fn = () => {\n    //     const result = finallyFn();\n    //     result instanceof Mypromise ? result.then(resolve, reject) : resolve(result);\n    //   }\n    //   this.resolveCallBacks.push(fn);\n    //   this.rejectCallBacks.push(fn);\n    // });\n\n    // 方式二\n    return this.then(\n      (value) => {\n        return Mypromise.resolve(finallyFn()).then(() => {\n            return value;\n        });\n      },\n      (err) => {\n        return Mypromise.resolve(finallyFn()).then(() => {\n          throw err;\n        });\n      }\n    );\n  }\n}\n\nmodule.exports = Mypromise"],"names":["stateMap","PENDING","FULFILED","REJECT","Mypromise","ps","pCount","length","count","resultArr","Array","resolve","reject","forEach","p","idx","resolveCallBack","data","rejectCallBack","then","err","value","executor","state","resolveCallBacks","rejectCallBacks","args","setTimeout","cb","error","resolveFn","rejectFn","push","result","catchFn","finallyFn","module","exports"],"mappings":"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"}